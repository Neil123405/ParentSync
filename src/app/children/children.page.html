<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="end">
      <ion-button (click)="openAddStudentModal()">
        <ion-icon name="add"></ion-icon>
      </ion-button>
      <ion-button (click)="refreshData()">
        <ion-icon name="refresh" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button (click)="logout()">
        <ion-icon name="log-out" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- Horizontal Students Section -->
  <!-- List of Children -->
  <div class="students-horizontal-section ion-padding-top">
    <h2>Your Children</h2>
    <div class="students-horizontal-container">
      <div 
        *ngFor="let child of laravelChildren" 
        class="student-card-horizontal"
        [class.active]="selectedChild?.student_id === child.student_id"
        (click)="selectChild(child)"
        style="position: relative;"
      >
        <div class="student-avatar">
          <ng-container *ngIf="child.photo_url; else childNoPhoto">
            <img [src]="child.photo_url"
                 alt="Student Photo"
                 style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;" />
          </ng-container>
          <ng-template #childNoPhoto>
            <ion-icon name="person-circle" style="font-size: 40px; color: #888;"></ion-icon>
          </ng-template>
        </div>
        <div class="student-info">
          <h4>{{ child.first_name }}</h4>
          <h4>{{ child.last_name }}</h4>
          <p>Grade {{ child.grade_level }}</p>
          <p>{{ child.section_name }}</p>
          <div style="margin-top: 8px;">
            <ion-badge color="primary">
              {{
                (consentFormCounts[child.student_id] || 0) +
                (schoolEventCounts[child.student_id] || 0)
              }} Items
            </ion-badge>
          </div>
        </div>
        <!-- Three-dot menu at top right -->
        <ion-button
          fill="clear"
          size="small"
          style="position: absolute; top: 0; right: 0; z-index: 2;"
          (click)="openChildOptions($event, child)">
          <ion-icon name="ellipsis-vertical"></ion-icon>
        </ion-button>
      </div>
    </div>
  </div>

  <!-- Action Buttons (Tasks & Timeline) -->
  <div class="ion-padding action-buttons" style="display: flex; gap: 8px;">
    <ion-button
      expand="block"
      color="primary"
      [disabled]="!selectedChild"
      [fill]="activeSection === 'tasks' ? 'solid' : 'outline'"
      (click)="showSection('tasks')"
      style="flex: 1;"
    >
      <ion-icon name="list" slot="start"></ion-icon>
      Tasks
    </ion-button>
    <ion-button
      expand="block"
      color="secondary"
      [disabled]="!selectedChild"
      [fill]="activeSection === 'timeline' ? 'solid' : 'outline'"
      (click)="showSection('timeline')"
      style="flex: 1;"
    >
      <ion-icon name="time" slot="start"></ion-icon>
      Timeline
    </ion-button>
  </div>

  <!-- Consent Forms and School Events Buttons under Tasks -->
  <div *ngIf="activeSection === 'tasks' && selectedChild" class="ion-padding tasks-buttons">
    <div class="task-btn-wrapper">
      <ion-button expand="block" class="task-btn" (click)="goToConsentForms(selectedChild)">
        <ion-icon name="document-text" slot="start"></ion-icon>
        Consent Forms
      </ion-button>
      <span class="task-badge">{{ consentForms.length }}</span>
    </div>
    <div class="task-btn-wrapper">
      <ion-button expand="block" class="task-btn" (click)="goToSchoolEvents(selectedChild)">
        <ion-icon name="calendar" slot="start"></ion-icon>
        School Events
      </ion-button>
      <span class="task-badge">{{ studentEvents.length }}</span>
    </div>
  </div>

  <!-- Consent Forms Section -->
  <div *ngIf="activeSection === 'consent' && selectedChild" class="ion-padding">
    <ion-list>
      <ion-item *ngFor="let form of consentForms">
        <ion-label>
          <h3>{{ form.title }}</h3>
          <p>{{ form.description }}</p>
          <p *ngIf="form.signed" style="color: green;">Signed</p>
          <p *ngIf="!form.signed" style="color: red;">Not Signed</p>
        </ion-label>
      </ion-item>
      <ion-item *ngIf="consentForms.length === 0">
        <ion-label>No consent forms found.</ion-label>
      </ion-item>
    </ion-list>
  </div>

  <!-- Timeline Section -->
  <ion-list *ngIf="activeSection === 'timeline' && selectedChild">
    <ion-item *ngFor="let form of signedConsentForms[selectedChild.student_id]">
      <ion-label>
        <h3>{{ form.title }}</h3>
        <p>Signed at: {{ form.signed_at | date:'medium' }}</p>
      </ion-label>
    </ion-item>
    <ion-item *ngIf="signedConsentForms[selectedChild.student_id]?.length === 0">
      <ion-label>No signed consent forms.</ion-label>
    </ion-item>
  </ion-list>

  <!-- School Events List (dropdown style) -->
  <ion-list *ngIf="showSchoolEvents && activeSection === 'tasks' && selectedChild">
    <ion-item *ngFor="let event of studentEvents" (click)="openEventDetail(event)">
      <ion-label>
        <h2>{{ event.title }}</h2>
        <p>{{ event.date }} - {{ event.location }}</p>
      </ion-label>
    </ion-item>
    <ion-item *ngIf="studentEvents.length === 0">
      <ion-label>No school events found.</ion-label>
    </ion-item>
  </ion-list>

  <!-- Default message when no child is selected -->
  <div *ngIf="!selectedChild && laravelChildren.length > 0" class="no-selection ion-padding">
    <ion-card>
      <ion-card-content class="ion-text-center">
        <ion-icon name="arrow-up" size="large"></ion-icon>
        <h3>Select a child above to view their information</h3>
        <p>Click on any child to see their consent forms, attendance, and school events.</p>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Add bottom padding -->
  <div style="height: 80px;"></div>
  
</ion-content>
