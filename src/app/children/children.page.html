<ion-header>
  <ion-toolbar>
    <ion-title class="children-title">
      <ion-icon name="people-outline" style="font-size: 1.5rem; margin-right: 8px; vertical-align: middle;"></ion-icon>
      Children</ion-title>
  </ion-toolbar>
</ion-header>











<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="refreshData($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>







  <!-- Floating Add Button -->
  <!-- <button class="floating-add-btn" (click)="openAddStudentModal()">
    <ion-icon name="add"></ion-icon>
  </button> -->

  <!-- Horizontal Students Section -->
  <!-- List of Children -->
  <div class="students-horizontal-section ion-padding-top">
    <div class="students-carousel-container">
      <!-- Navigation arrows -->
      <button class="nav-arrow nav-arrow-left" [disabled]="centerCardIndex === 0" (click)="goToPrevCard()">
        <ion-icon name="chevron-back"></ion-icon>
      </button>

      <button class="nav-arrow nav-arrow-right" [disabled]="centerCardIndex === laravelChildren.length - 1"
        (click)="goToNextCard()">
        <ion-icon name="chevron-forward"></ion-icon>
      </button>

      <div class="students-carousel-wrapper" #carouselWrapper (pan)="onPan($event)" (panend)="onPanEnd($event)"
        (swipe)="onSwipe($event)">

        <!-- there are a lot of children, so with class.active we can highlight the selected child -->
        <div *ngFor="let child of laravelChildren; let i = index" class="student-card-carousel"
          [class.active]="selectedChild?.student_id === child.student_id" [class.center]="centerCardIndex === i"
          [class.left]="i < centerCardIndex" [class.right]="i > centerCardIndex"
          [class.long-pressed]="longPressedId === child.student_id" (click)="selectChildAndCenter(child, i)"
          (mousedown)="startPress($event, child)" (mouseup)="endPress()" (mouseleave)="endPress()"
          (touchstart)="startPress($event, child)" (touchend)="endPress()" [style.transform]="getCardTransform(i)"
          style="position: absolute;">

          <!-- Badge at top right -->
          <span class="student-badge">
            {{
            (consentFormCounts[child.student_id] || 0) +
            (schoolEventCounts[child.student_id] || 0) +
            (announcementCounts[child.student_id] || 0)
            }}
          </span>

          <div class="student-avatar">
            <ng-container *ngIf="child.photo_url && child.photo_url.startsWith('http'); else childNoPhoto">
              <img [src]="child?.photo_url" alt="Student Photo" />
            </ng-container>
            <ng-template #childNoPhoto>
              <ion-icon name="person-circle"></ion-icon>
            </ng-template>
          </div>

          <div class="student-info">
            <h4>{{ child.first_name }}</h4>
            <h4>{{ child.last_name }}</h4>
            <p>Grade {{ child.grade_level }}</p>
          </div>
        </div>
      </div>

      <!-- Navigation indicators -->
      <!-- <div class="carousel-indicators" *ngIf="laravelChildren.length > 1">
        <span *ngFor="let child of laravelChildren; let i = index" class="indicator-dot"
          [class.active]="centerCardIndex === i" (click)="goToCard(i)"></span>
      </div> -->
    </div>
  </div>

  <!-- Action Buttons (Tasks & Timeline) -->
  <div class="ion-padding action-buttons" style="display: flex; gap: 8px;">
    <ion-button expand="block" color="primary" [disabled]="!selectedChild"
      [fill]="activeSection === 'tasks' ? 'solid' : 'outline'" (click)="showSection('tasks')" style="flex: 1;">
      <ion-icon name="list" slot="start"></ion-icon>
      Tasks
    </ion-button>
    <ion-button expand="block" color="secondary" [disabled]="!selectedChild"
      [fill]="activeSection === 'timeline' ? 'solid' : 'outline'" (click)="showSection('timeline')" style="flex: 1;">
      <ion-icon name="time" slot="start"></ion-icon>
      Timeline
    </ion-button>
  </div>

  <!-- Consent Forms and School Events Buttons under Tasks -->
  <!-- Replace the existing tasks-buttons div (lines 110-144) with: -->

  <!-- Consent Forms and School Events Buttons under Tasks -->
  <div *ngIf="activeSection === 'tasks' && selectedChild" class="tasks-section">
    <div class="task-card task-card-blue" (click)="goToConsentForms(selectedChild)">
      <div class="task-card-header">
        <div class="task-icon-wrapper">
          <img src="assets/images/consent.png" alt="Consent Forms" class="task-icon" />
        </div>
        <div class="task-badge-top">
          {{ consentFormCounts[selectedChild.student_id] || 0 }}
        </div>
      </div>
      <div class="task-card-body">
        <h3 class="task-title">Consent Forms</h3>
        <div class="task-preview">
          <div *ngFor="let form of upcomingConsentForms.slice(0, 3); let i = index" class="preview-item">
            <p class="preview-title">{{ form.title }}</p>
            <p class="preview-date">Due: {{ form.deadline | date:'MMM d' }}</p>
          </div>
          <p *ngIf="upcomingConsentForms.length === 0" class="no-data">No upcoming forms</p>
        </div>
      </div>

      <!-- <div class="task-card-body">
      <h3 class="task-title">Consent Forms</h3>
      <p class="task-subtitle">Pending documents</p>
      
      <div class="task-stats">
        <div class="stat-item">
          <span class="stat-number">{{ consentFormCounts[selectedChild.student_id] || 0 }}</span>
          <span class="stat-label">pending</span>
        </div>
        <div class="stat-item">
          <span class="stat-number">--</span>
          <span class="stat-label">signed</span>
        </div>
        <div class="stat-item">
          <span class="stat-number">--</span>
          <span class="stat-label">total</span>
        </div>
      </div>
    </div> -->

      <!-- <div class="task-card-footer">
      <span class="ranking-label">Priority</span>
      <span class="ranking-number">High</span>
    </div> -->
    </div>

    <div class="task-card task-card-pink" (click)="goToSchoolEvents(selectedChild)">
      <div class="task-card-header">
        <div class="task-icon-wrapper">
          <img src="assets/images/events.png" alt="School Events" class="task-icon" />
        </div>
        <div class="task-badge-top">
          {{ schoolEventCounts[selectedChild.student_id] || 0 }}
        </div>
      </div>
      <div class="task-card-body">
        <h3 class="task-title">Events</h3>
        <div class="task-preview">
          <div *ngFor="let event of upcomingEvents.slice(0, 3); let i = index" class="preview-item">
            <p class="preview-title">{{ event.title }}</p>
            <p class="preview-date">Date: {{ event.date | date:'MMM d' }}</p>
          </div>
          <p *ngIf="upcomingEvents.length === 0" class="no-data">No upcoming events</p>
        </div>
      </div>
    </div>

    <div class="task-card task-card-purple" (click)="goToStudentAnnouncements(selectedChild)">
      <div class="task-card-header">
        <div class="task-icon-wrapper">
          <img src="assets/images/announcements.png" alt="Announcements" class="task-icon" />
        </div>
        <div class="task-badge-top">
          {{ announcementCounts[selectedChild.student_id] || 0 }}
        </div>
      </div>

      <!-- <div class="task-card-body">
      <h3 class="task-title">Announcements</h3>
      <p class="task-subtitle">Recent updates</p>
      
      <div class="task-stats">
        <div class="stat-item">
          <span class="stat-number">{{ announcementCounts[selectedChild.student_id] || 0 }}</span>
          <span class="stat-label">unread</span>
        </div>
        <div class="stat-item">
          <span class="stat-number">--</span>
          <span class="stat-label">read</span>
        </div>
        <div class="stat-item">
          <span class="stat-number">--</span>
          <span class="stat-label">total</span>
        </div>
      </div>
    </div> -->

      <!-- <div class="task-card-footer">
      <span class="ranking-label">Priority</span>
      <span class="ranking-number">Low</span>
    </div> -->
      <div class="task-card-body">
        <h3 class="task-title">Announcements</h3>
        <div class="task-preview">
          <div *ngFor="let announcement of recentAnnouncements.slice(0, 3); let i = index" class="preview-item">
            <p class="preview-title">{{ announcement.title }}</p>
            <p class="preview-date">{{ announcement.created_at | date:'MMM d' }}</p>
          </div>
          <p *ngIf="recentAnnouncements.length === 0" class="no-data">No recent announcements</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Consent Forms Section -->


  <!-- Announcements Section
<div *ngIf="activeSection === 'announcements' && selectedChild" class="ion-padding">
  <ion-list>
    <ion-item *ngFor="let announcement of studentAnnouncements">
      <ion-label>
        <h3>{{ announcement.title }}</h3>
        <p>{{ announcement.content }}</p>
        <p style="font-size: 0.9em; color: #888;">{{ announcement.date | date:'mediumDate' }}</p>
      </ion-label>
    </ion-item>
    <ion-item *ngIf="studentAnnouncements.length === 0">
      <ion-label>No announcements found.</ion-label>
    </ion-item>
  </ion-list>
  <ion-button expand="block" (click)="showSection('tasks')" color="medium" style="margin-top: 16px;">
    Back to Tasks
  </ion-button>
</div> -->

  <!-- Consent Forms Section -->
  <!-- <div *ngIf="activeSection === 'consent' && selectedChild" class="ion-padding">
    <ion-list>
      <ion-item *ngFor="let form of consentForms">
        <ion-label>
          <h3>{{ form.title }}</h3>
          <p>{{ form.description }}</p>
          <p *ngIf="form.signed" style="color: green;">Signed</p>
          <p *ngIf="!form.signed" style="color: red;">Not Signed</p>
        </ion-label>
      </ion-item>
      <ion-item *ngIf="consentForms.length === 0">
        <ion-label>No consent forms found.</ion-label>
      </ion-item>
    </ion-list>
  </div> -->

  <!-- Timeline Section -->
  <ion-list *ngIf="activeSection === 'timeline' && selectedChild">
    <ion-item *ngFor="let form of signedConsentForms[selectedChild.student_id]" (click)="openConsentFormDetail(form)">
      <ion-label>
        <h3>{{ form.title }}</h3>
        <p><ion-icon name="time-outline" style="vertical-align: middle; margin-right: 4px;"></ion-icon>Signed at: {{
          form.signed_at | date:'medium' }}</p>
      </ion-label>
    </ion-item>
    <ion-item *ngIf="signedConsentForms[selectedChild.student_id]?.length === 0">
      <ion-label>No signed consent forms.</ion-label>
    </ion-item>
  </ion-list>

  <!-- Decorative School Events Button (not clickable) -->
  <!-- <div *ngIf="activeSection === 'schoolEvents' && selectedChild" class="task-btn-wrapper" style="margin-bottom: 24px;">
  <ion-button expand="block" class="task-btn giant-btn" disabled>
    <span class="btn-content">
      <img src="assets/images/events.png" alt="School Events" class="task-img-giant" />
      <span class="btn-label">School Events</span>
    </span>
  </ion-button>
</div> -->
  <!-- School Events List (dropdown style) -->
  <!-- <ion-list *ngIf="showSchoolEvents && activeSection === 'tasks' && selectedChild">
    <ion-item *ngFor="let event of studentEvents" (click)="openEventDetail(event)">
      <ion-label>
        <h2>{{ event.title }}</h2>
        <p>{{ event.date }} - {{ event.location }}</p>
      </ion-label>
    </ion-item>
    <ion-item *ngIf="studentEvents.length === 0">
      <ion-label>No school events found.</ion-label>
    </ion-item>
  </ion-list> -->

  <!-- Default message when no child is selected -->
  <div *ngIf="!selectedChild && laravelChildren.length > 0" class="no-selection ion-padding">
    <ion-card>
      <ion-card-content class="ion-text-center">
        <ion-icon name="arrow-up" size="large"></ion-icon>
        <h3>Select a child above to view their information</h3>
        <p>Click on any child to see their consent forms, school events, and announcements</p>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Pending Students Section -->
  <ion-list *ngIf="pendingStudents.length">
    <ion-list-header color="warning">Pending Students</ion-list-header>
    <ion-item *ngFor="let student of pendingStudents">
      <ion-label>
        (ID: {{ student.student_id }})
      </ion-label>
      <ion-note slot="end" color="warning">Pending Verification</ion-note>
    </ion-item>
  </ion-list>

  <!-- Add bottom padding -->
  <div style="height: 80px;"></div>

</ion-content>