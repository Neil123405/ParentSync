<ion-header>
  <div class="smiling-header">
    <div class="header-top-row">
      <div class="header-circle circle-1"></div>
      <div class="header-circle circle-2"></div>
      <div class="header-circle circle-3"></div>
      <div class="header-circle circle-4"></div>
      <div class="header-circle circle-5"></div>
      <h1 class="welcome-message"><span style="font-size: 2rem; font-weight: bold;">Welcome</span> <br />{{
        parent?.first_name || 'User' }}!</h1>
      <div class="parent-photo-topright">
        <ng-container *ngIf="parent?.photo_url; else noPhoto">
          <img [src]="parent?.photo_url" alt="Parent Photo" class="user-photo" />
        </ng-container>
        <ng-template #noPhoto>
          <ion-icon name="person-circle" class="default-photo"></ion-icon>
        </ng-template>
      </div>
    </div>
    <div class="header-footer">
      <div class="tab-button-group">
        <button class="tab-btn" [class.active]="activeTab === 'announcements'" (click)="setTab('announcements')">
          Announcements
        </button>
        <button class="tab-btn" [class.active]="activeTab === 'events'" (click)="setTab('events')">
          Events
        </button>
      </div>
    </div>
  </div>
</ion-header>



<ion-content [fullscreen]="true" class="ion-padding content-with-footer">
  <ion-refresher slot="fixed" (ionRefresh)="refreshData($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div *ngIf="activeTab === 'announcements'">
    <!-- Announcements content goes here -->
    <div class="student-photo-header">
      <ng-container *ngFor="let student of studentsWithAnnouncements">
        <ng-container *ngIf="student.photo_url && student.photo_url.startsWith('http'); else noPhoto">
          <img [src]="student.photo_url" alt="Student Photo" class="student-photo"
            (click)="goToStudentAnnouncements(student.student_id)" />
        </ng-container>
        <ng-template #noPhoto>
          <ion-icon name="person-circle" class="default-photo" (click)="goToStudentAnnouncements(student.student_id)">
          </ion-icon>
        </ng-template>
      </ng-container>
    </div>

    <!-- Announcements List -->
    <ng-container *ngFor="let group of groupedAnnouncements" class="announcement-card-custom">
      <div style="margin-bottom: 6px;">
        <!-- Student photo/icon OUTSIDE the card -->

        <!-- The announcement card -->
        <ion-card class="announcement-card clickable"
          [ngClass]="{'school-card': group.announcement.scope === 'school', 'section-card': group.announcement.scope === 'section'}"
          (click)="openAnnouncement(group.announcement)">
          <ion-card-content
            style="flex: 1; display: flex; flex-direction: row; justify-content: flex-start; align-items: center;">
            <div class="student-photos">
              <!-- gets the student by ID and checks if they have a photo URL -->
              <ng-container *ngFor="let studentId of group.studentIds.slice(0, 3); let i = index"
                class="student-photo-card">
                <div class="photo-wrapper-column">
                  <ng-container
                    *ngIf="getStudentById(studentId)?.photo_url && getStudentById(studentId)?.photo_url.startsWith('http'); else noPhoto">
                    <img [src]="getStudentById(studentId)?.photo_url" alt="Student Photo"
                      class="student-photo-overlap" />
                  </ng-container>
                  <ng-template #noPhoto>
                    <ion-icon name="person-circle" class="student-no-photo"></ion-icon>
                  </ng-template>
                </div>
              </ng-container>
            </div>
            <div
              style="flex: 1; display: flex; flex-direction: column; align-items: flex-start; justify-content: center;">
              <h3
                style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">
                <ion-icon name="megaphone-outline" style="font-size: 1.5rem; color: #3880ff; margin-right: 10px;">
                </ion-icon>
                <span style="font-size: 1.5rem; font-weight: bold;">
                  {{ group.announcement.title }}
                </span>
                <br />
                <ion-icon name="people-outline" style="font-size: 1.5rem; color: #666; margin-right: 10px;"></ion-icon>
                <span style="color: #fff;">
                  scope: {{ group.announcement.scope }}
                </span>
              </h3>
            </div>
          </ion-card-content>
        </ion-card>
      </div>
    </ng-container>

    <ion-item *ngIf="filteredAnnouncements.length === 0">
      <ion-label class="ion-text-center">
        No announcements available.
      </ion-label>
    </ion-item>

  </div>
  <div *ngIf="activeTab === 'events'">
    <!-- Events content goes here -->
    <div class="student-photo-header">
      <ng-container *ngFor="let student of studentsWithEvents">
        <ng-container *ngIf="student.photo_url && student.photo_url.startsWith('http'); else noPhotoEvent">
          <img [src]="student.photo_url" alt="Student Photo"
            style="width: 56px; height: 56px; border-radius: 50%; object-fit: cover; border: 3px solid #fff; box-shadow: 0 0 0 2px #e0e0e0; cursor: pointer;"
            (click)="goToStudentEvents(student.student_id)" />
        </ng-container>
        <ng-template #noPhotoEvent>
          <ion-icon name="person-circle" style="font-size: 56px; cursor: pointer;
      color: #3880ff;
    background: #fff;
    border-radius: 50%;
    border: #fff;" (click)="goToStudentEvents(student.student_id)">
          </ion-icon>
        </ng-template>
      </ng-container>
    </div>

    <!-- Events List -->
    <div *ngFor="let event of filteredEvents" class="event-list-item">
      <ion-card (click)="openEventDetail(event)" class="event-card-custom clickable"
        [ngClass]="{'school-card': event.scope === 'school','section-card': event.scope === 'class'}">

        <ion-card-content class="card-ion">

          <div class="student-photo-card">
            <ng-container *ngIf="event.studentIds?.length; else singleStudent">
              <ng-container *ngFor="let studentId of event.studentIds.slice(0, 3)">
                <div class="student-photo-card">
                  <ng-container
                    *ngIf="getStudentById(studentId)?.photo_url && getStudentById(studentId)?.photo_url.startsWith('http'); else noPhotoEvent">
                    <img [src]="getStudentById(studentId)?.photo_url" alt="Student Photo"
                      class="student-photo-overlap" />
                  </ng-container>
                  <ng-template #noPhotoEvent>
                    <ion-icon name="person-circle" class="student-no-photo"></ion-icon>
                  </ng-template>
                </div>
              </ng-container>
            </ng-container>
            <ng-template #singleStudent>
              <div class="student-photo-card">
                <ng-container
                  *ngIf="getStudentById(event.student_id)?.photo_url && getStudentById(event.student_id)?.photo_url.startsWith('http'); else noPhotoEventSingle">
                  <img [src]="getStudentById(event.student_id)?.photo_url" alt="Student Photo"
                    class="student-photo-overlap" />
                </ng-container>
                <ng-template #noPhotoEventSingle>
                  <ion-icon name="person-circle" class="student-no-photo"></ion-icon>
                </ng-template>
              </div>
            </ng-template>
          </div>

          <div style="flex: 1;">
            <h3
              style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">
              <ion-icon name="calendar-outline"
                style="font-size: 1.5rem; color: #10dc60; margin-right: 10px;"></ion-icon>
              {{ event.title }}
              <br />
              <ion-icon name="people-outline" style="font-size: 1.5rem; color: #666; margin-right: 10px;"></ion-icon>
              scope: {{ event.scope }}
            </h3>
            <div class="card-date" style="margin-top: 8px;">
              <ion-icon name="time-outline" style="vertical-align: middle; margin-right: 4px;"></ion-icon>
              {{ event.date | date:'mediumDate' }}
            </div>
          </div>
        </ion-card-content>
      </ion-card>
    </div>
    <ion-item *ngIf="filteredEvents.length === 0">
      <ion-label class="ion-text-center">No events available.</ion-label>
    </ion-item>

  </div>

  <div style="height: 48px;"></div>
</ion-content>